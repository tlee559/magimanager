generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // For migrations (non-pooled connection)
}

model IdentityProfile {
  id        String  @id @default(cuid())
  fullName  String
  dob       DateTime
  address   String
  city      String
  state     String
  zipcode   String  @default("")
  geo       String  // Changed from 'country' to 'geo'
  website   String?
  notes     String? // Internal notes about this identity

  // Credentials (sensitive - encrypt in application layer)
  email           String?   // Gmail for this identity
  emailPassword   String?   // Encrypted
  phone           String?   // 2FA phone number
  twoFactorSecret String?   // 2FA secret (encrypted)
  backupCodes     String?   // Encrypted JSON array of backup codes

  // Phone verification via TextVerified
  verificationPhone     String?   // Phone number obtained from TextVerified
  verificationPhoneId   String?   // TextVerified verification ID (for status checks)
  verificationStatus    String?   // pending, received, verified, expired
  verificationCode      String?   // The received SMS code
  verificationExpiresAt DateTime? // When the verification rental expires

  // Billing info (sensitive - encrypt in application layer)
  // One card per identity
  ccNumber          String?   // Full number encrypted
  ccExp             String?   // Expiration MM/YY
  ccCvv             String?   // CVV encrypted
  ccName            String?   // Name on card
  billingZip        String?   // Billing zipcode

  // Archive status
  archived    Boolean @default(false)
  archivedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  documents IdentityDocument[]
  adAccounts AdAccount[]
  gologinProfile GoLoginProfile?
  activities IdentityActivity[]
}

model IdentityDocument {
  id                String   @id @default(cuid())
  identityProfileId String
  type              String
  filePath          String
  uploadedAt        DateTime @default(now())

  profile IdentityProfile @relation(fields: [identityProfileId], references: [id])
}

model AdAccount {
  id                String   @id @default(cuid())
  internalId        Int      @unique @default(autoincrement()) // Auto-incrementing internal ID number
  googleCid         String?  @unique // Unique constraint - one CID per account
  identityProfileId String?  @unique // Unique constraint - one identity per account (1:1 relationship)
  origin            String   @default("mcc-created") // "mcc-created" | "takeover"
  status            String   @default("provisioned")
  warmupTargetSpend Int      @default(5000) // Default $50 warmup target (in cents)
  currentSpendTotal Int      @default(0)   // All-time spend in cents
  todaySpend        Int      @default(0)   // Today's spend in cents
  adsCount          Int      @default(0)
  campaignsCount    Int      @default(0)

  // Account identifiers
  mccId             String?   // MCC account ID

  // Operational status
  accountHealth     String    @default("unknown") // "active" | "suspended" | "unknown"
  billingStatus     String    @default("not_started") // "not_started" | "pending" | "verified" | "failed"
  certStatus        String?   // "pending" | "verified" | "errored" | "suspended"

  // Handoff tracking
  handoffStatus     String      @default("available")  // "available" | "handed-off" | "archived"
  mediaBuyerId      String?     // FK to MediaBuyer
  handoffDate       DateTime?
  handoffNotes      String?

  // Internal notes (deprecated - use thread instead)
  notes             String?     // Internal notes about this account

  // Google Ads OAuth sync
  connectionId          String?  // FK to GoogleAdsConnection
  connectionType        String   @default("manual")  // "manual" | "oauth" | "mcc"
  syncStatus            String   @default("not_connected")  // "not_connected" | "syncing" | "synced" | "error"
  lastGoogleSyncAt      DateTime?
  googleSyncError       String?
  googleCidVerified     Boolean  @default(false)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  identityProfile IdentityProfile? @relation(fields: [identityProfileId], references: [id])
  mediaBuyer      MediaBuyer?     @relation(fields: [mediaBuyerId], references: [id])
  connection      GoogleAdsConnection? @relation(fields: [connectionId], references: [id])
  thread          AccountThread?
  checkIns        AccountCheckIn[]
  activities      AccountActivity[]
  dailySnapshots  DailySpendSnapshot[]
}

model GoLoginProfile {
  id                  String   @id @default(cuid())
  identityProfileId   String   @unique
  profileId           String?  // GoLogin's actual profile ID
  profileName         String?  // Name shown in GoLogin
  status              String   @default("pending") // pending, ready, error
  errorMessage        String?  // If creation failed

  // Proxy configuration
  proxyMode           String   @default("none") // none, http, socks5, gologin
  proxyHost           String?
  proxyPort           Int?
  proxyUsername       String?
  proxyPassword       String?
  proxyCountry        String?  // Country code matching identity geo

  // Profile health tracking
  lastUsedAt          DateTime?
  fingerprintRefreshedAt DateTime? // When fingerprint was last refreshed
  browserVersion      String?      // Current Chrome version in profile

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  identityProfile IdentityProfile @relation(fields: [identityProfileId], references: [id])
}

model MediaBuyer {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phone     String?
  notes     String?
  isActive  Boolean  @default(true)
  userId    String?  @unique // Link to User model
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  adAccounts AdAccount[]
  user       User?     @relation(fields: [userId], references: [id])
}

model AppSettings {
  id                    String   @id @default(cuid())
  warmupTargetSpend     Int      @default(5000) // Default $50 warmup target (in cents)

  // API Keys
  gologinApiKey         String?
  googleAdsApiKey       String?
  googleApiKey          String?  // General Google API key
  textverifiedApiKey    String?  // TextVerified API key for phone verification
  telegramBotToken      String?  // Telegram bot token from @BotFather
  telegramChatId        String?  // Telegram chat/group ID for notifications

  updatedAt             DateTime @updatedAt
}

model ChildAccountJob {
  id                String   @id @default(cuid())
  identityProfileId String
  requestedByUserId String?
  status            String   @default("queued")
  googleCid         String?
  errorMessage      String?
  createdAt         DateTime @default(now())
}

// ============================================================================
// USER & TEAM MANAGEMENT
// ============================================================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  MEDIA_BUYER
  ASSISTANT
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

model User {
  id                   String      @id @default(cuid())
  email                String      @unique
  name                 String
  password             String      // Hashed password
  role                 UserRole    @default(MEDIA_BUYER)
  status               UserStatus  @default(ACTIVE)
  firstLogin           Boolean     @default(true)
  unreadNotifications  Int         @default(0)
  lastLoginAt          DateTime?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt

  mediaBuyer           MediaBuyer?
  threadMessages       ThreadMessage[]
  accountRequests      AccountRequest[]
  notifications        Notification[]
  accountActivities    AccountActivity[]   @relation("AccountActivities")
  identityActivities   IdentityActivity[]  @relation("IdentityActivities")
}

// ============================================================================
// CONVERSATION THREADS
// ============================================================================

model AccountThread {
  id          String   @id @default(cuid())
  adAccountId String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  adAccount AdAccount        @relation(fields: [adAccountId], references: [id])
  messages  ThreadMessage[]
}

model ThreadMessage {
  id             String   @id @default(cuid())
  threadId       String
  authorId       String
  authorName     String
  authorRole     UserRole
  message        String   @db.Text
  isRead         Boolean  @default(false)
  createdAt      DateTime @default(now())
  editedAt       DateTime?  // Set when message is edited

  thread AccountThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  author User          @relation(fields: [authorId], references: [id])
}

// ============================================================================
// ACCOUNT REQUESTS
// ============================================================================

enum RequestType {
  CLAIM_EXISTING
  CREATE_NEW
}

enum RequestStatus {
  PENDING
  APPROVED
  PROFILE_CREATED
  GOLOGIN_SETUP
  ACCOUNT_CREATED
  ASSIGNED
  ACTIVE
  REJECTED
  ARCHIVED
}

model AccountRequest {
  id              String        @id @default(cuid())
  requesterId     String
  type            RequestType
  status          RequestStatus @default(PENDING)
  justification   String        @db.Text
  existingAccountId String?     // For CLAIM_EXISTING requests
  createdAccountId  String?     // Filled when approved CREATE_NEW
  reviewedAt      DateTime?
  reviewedBy      String?
  rejectionReason String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  requester User @relation(fields: [requesterId], references: [id])
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

enum NotificationType {
  NEW_MESSAGE
  REQUEST_APPROVED
  REQUEST_REJECTED
  ACCOUNT_ASSIGNED
  ACCOUNT_SUSPENDED
  ACCOUNT_REACTIVATED
  SYSTEM_ALERT
  VIDEO_CLIP_COMPLETED
}

model Notification {
  id         String           @id @default(cuid())
  userId     String?          // Optional - null for system-wide notifications
  type       NotificationType
  title      String
  message    String           @db.Text
  isRead     Boolean          @default(false)
  entityId   String?          // ID of related account/request/thread
  entityType String?          // "account" | "request" | "thread"
  priority   String           @default("medium") // "low" | "medium" | "high"
  createdAt  DateTime         @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================================================
// DAILY CHECK-INS & ACTIVITY TIMELINE
// ============================================================================

model AccountCheckIn {
  id              String   @id @default(cuid())
  adAccountId     String

  // Daily metrics
  dailySpend      Decimal  @default(0) @db.Decimal(10, 2)
  totalSpend      Decimal  @default(0) @db.Decimal(10, 2)
  adsCount        Int      @default(0)
  campaignsCount  Int      @default(0)

  // Status at check-in time
  accountHealth   String   // "active" | "limited" | "suspended" | "banned"
  billingStatus   String   // "verified" | "pending" | "failed"
  certStatus      String?

  // Issues/notes
  issues          String?  @db.Text // Any flags or problems
  notes           String?  @db.Text // Free-form notes

  checkedAt       DateTime @default(now())
  checkedBy       String?  // User ID who logged this

  adAccount       AdAccount @relation(fields: [adAccountId], references: [id], onDelete: Cascade)
}

model AccountActivity {
  id              String   @id @default(cuid())
  adAccountId     String

  action          String   // "CREATED", "GMAIL_SUS", "CERT_SUBMITTED", "APPEAL_DENIED", etc.
  details         String?  @db.Text // Additional context

  createdAt       DateTime @default(now())
  createdBy       String?  // User ID who created this entry

  adAccount       AdAccount @relation(fields: [adAccountId], references: [id], onDelete: Cascade)
  createdByUser   User?     @relation("AccountActivities", fields: [createdBy], references: [id])
}

model IdentityActivity {
  id                  String   @id @default(cuid())
  identityProfileId   String

  action              String   // "CREATED", "DOCUMENT_UPLOADED", "GOLOGIN_CREATED", "GOLOGIN_DELETED", etc.
  details             String?  @db.Text // Additional context

  createdAt           DateTime @default(now())
  createdBy           String?  // User ID who created this entry

  identityProfile     IdentityProfile @relation(fields: [identityProfileId], references: [id], onDelete: Cascade)
  createdByUser       User?           @relation("IdentityActivities", fields: [createdBy], references: [id])
}

// ============================================================================
// DISMISSED ALERTS
// ============================================================================

model DismissedAlert {
  id              String   @id @default(cuid())
  adAccountId     String
  alertType       String   // "suspended", "billing_failed", "no_checkin", "cert_error", "ready_handoff", etc.
  dismissedBy     String   // User ID who dismissed
  dismissedAt     DateTime @default(now())

  // Unique constraint: one dismissed alert per account+type combination
  @@unique([adAccountId, alertType])
}

// ============================================================================
// DAILY SPEND HISTORY (for trend tracking)
// ============================================================================

model DailySpendSnapshot {
  id              String   @id @default(cuid())
  adAccountId     String
  date            DateTime @db.Date  // The date this snapshot represents

  // Daily metrics
  dailySpend      Decimal  @default(0) @db.Decimal(10, 2)
  totalSpend      Decimal  @default(0) @db.Decimal(10, 2)
  adsCount        Int      @default(0)
  campaignsCount  Int      @default(0)

  // Status at snapshot time
  accountHealth   String
  billingStatus   String

  createdAt       DateTime @default(now())

  adAccount       AdAccount @relation(fields: [adAccountId], references: [id], onDelete: Cascade)

  // One snapshot per account per day
  @@unique([adAccountId, date])
  @@index([date])
}

// ============================================================================
// TELEGRAM BOT CONVERSATION MEMORY
// ============================================================================

model BotConversation {
  id              String   @id @default(cuid())
  chatId          String   // Telegram chat ID
  userId          String?  // Telegram user ID (optional for groups)

  // Conversation context (JSON array of last N messages)
  messages        String   @db.Text  // JSON: [{role: "user"|"assistant", content: string, timestamp: string}]

  // Extracted context from conversation
  lastIntent      String?  // Last detected intent
  lastAccountId   String?  // Last mentioned account (for follow-ups)
  lastTopicType   String?  // "accounts" | "alerts" | "identities" | etc.

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  expiresAt       DateTime // Auto-expire old conversations

  @@unique([chatId, userId])
  @@index([chatId])
  @@index([expiresAt])
}

// ============================================================================
// WEEKLY STATS SNAPSHOTS (for week-over-week comparisons)
// ============================================================================

model WeeklyStatsSnapshot {
  id              String   @id @default(cuid())
  weekStart       DateTime @db.Date  // Monday of the week

  // Account counts
  totalAccounts       Int @default(0)
  activeAccounts      Int @default(0)
  suspendedAccounts   Int @default(0)
  bannedAccounts      Int @default(0)
  limitedAccounts     Int @default(0)
  archivedAccounts    Int @default(0)

  // Financial metrics (in cents)
  totalSpend          Int @default(0)
  weeklySpendDelta    Int @default(0)  // Change from previous week

  // Operational metrics
  totalAds            Int @default(0)
  accountsCreated     Int @default(0)  // New accounts this week
  accountsHandedOff   Int @default(0)  // Accounts handed off this week
  checkInsCount       Int @default(0)  // Total check-ins this week

  // Identity metrics
  totalIdentities     Int @default(0)
  identitiesCreated   Int @default(0)  // New identities this week

  createdAt           DateTime @default(now())

  // One snapshot per week
  @@unique([weekStart])
}

// ============================================================================
// GOOGLE ADS OAUTH CONNECTIONS
// ============================================================================

model GoogleAdsConnection {
  id                String   @id @default(cuid())

  // OAuth tokens (encrypted at application layer)
  accessToken       String   @db.Text
  refreshToken      String   @db.Text
  tokenExpiresAt    DateTime

  // Google user info (who granted access)
  googleUserId      String   // Google account ID
  googleEmail       String   // Email for reference

  // Connection status
  status            String   @default("active")  // "active" | "revoked" | "expired"
  lastSyncAt        DateTime?
  lastSyncError     String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Accounts using this connection
  adAccounts        AdAccount[]
}

// ============================================================================
// KADABRA: AUTOMATION RULES
// ============================================================================

enum AutomationStatus {
  ACTIVE
  PAUSED
  DISABLED
  ERROR
}

enum TriggerType {
  SCHEDULE
  METRIC_THRESHOLD
  EVENT
  MANUAL
}

enum EntityScope {
  ACCOUNT
  CAMPAIGN
  AD_GROUP
  AD
  KEYWORD
}

enum ExecutionResult {
  SUCCESS
  FAILED
  SKIPPED
  PENDING
  WRITE_DISABLED
}

model AutomationRule {
  id                  String           @id @default(cuid())
  name                String
  description         String?          @db.Text
  status              AutomationStatus @default(PAUSED)
  priority            Int              @default(50)  // 1-100, lower = higher priority

  // Scope
  scope               EntityScope
  accountIds          String[]         // Apply to specific accounts (empty = all)
  campaignIds         String[]         // Apply to specific campaigns
  adGroupIds          String[]         // Apply to specific ad groups

  // Trigger configuration (JSON)
  trigger             String           @db.Text  // JSON: TriggerType config

  // Conditions (all must be true) - JSON array
  conditions          String           @db.Text  // JSON: AutomationCondition[]

  // Actions (executed in order) - JSON array
  actions             String           @db.Text  // JSON: AutomationAction[]

  // Limits
  maxExecutionsPerDay Int?
  cooldownMinutes     Int?             // Min time between executions

  // Feature flag - does this rule need write access to Google Ads?
  requiresWriteAccess Boolean          @default(false)

  // Execution tracking
  lastExecutedAt      DateTime?
  executionCount      Int              @default(0)

  // Metadata
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  createdBy           String           // User ID

  // Relations
  executions          AutomationExecution[]

  @@index([status])
  @@index([scope])
}

model AutomationExecution {
  id              String          @id @default(cuid())
  ruleId          String
  ruleName        String          // Denormalized for easier querying

  // Account context
  accountId       String

  // Execution timing
  triggeredAt     DateTime        @default(now())
  completedAt     DateTime?

  // Result
  result          ExecutionResult
  errorMessage    String?         @db.Text

  // Entity affected
  entityType      EntityScope
  entityId        String
  entityName      String

  // Actions taken (JSON array of ActionResult)
  actionsTaken    String          @db.Text  // JSON: ActionResult[]

  // State snapshots (before/after for audit)
  beforeState     String?         @db.Text  // JSON
  afterState      String?         @db.Text  // JSON

  // Relations
  rule            AutomationRule  @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@index([accountId])
  @@index([triggeredAt])
  @@index([result])
}

// ============================================================================
// KADABRA: AI INSIGHTS
// ============================================================================

enum InsightType {
  PERFORMANCE_ANOMALY
  OPTIMIZATION_OPPORTUNITY
  BUDGET_RECOMMENDATION
  KEYWORD_SUGGESTION
  AD_COPY_SUGGESTION
  BIDDING_RECOMMENDATION
  TREND_ANALYSIS
  COMPETITOR_INSIGHT
}

enum InsightPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum InsightStatus {
  NEW
  REVIEWED
  APPLIED
  DISMISSED
}

model AIInsight {
  id              String          @id @default(cuid())

  // Scope
  accountId       String
  campaignId      String?
  adGroupId       String?

  // Insight details
  type            InsightType
  priority        InsightPriority
  title           String
  summary         String          @db.Text
  details         String          @db.Text

  // AI recommendation (JSON)
  recommendation  String?         @db.Text  // JSON: {action, confidence, estimatedImpact, parameters}

  // Status tracking
  status          InsightStatus   @default(NEW)
  reviewedAt      DateTime?
  reviewedBy      String?         // User ID
  appliedAt       DateTime?

  // Outcome tracking (after applied)
  outcomeTracked  Boolean         @default(false)
  actualImpact    String?         @db.Text  // What actually happened

  // Timestamps
  createdAt       DateTime        @default(now())
  expiresAt       DateTime?       // Some insights are time-sensitive

  @@index([accountId])
  @@index([type])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

// ============================================================================
// KADABRA: CAMPAIGN SNAPSHOTS (for historical tracking)
// ============================================================================

model CampaignSnapshot {
  id              String   @id @default(cuid())
  accountId       String
  campaignId      String   // Google Ads campaign ID
  snapshotDate    DateTime @db.Date

  // State at snapshot time
  status          String   // ENABLED, PAUSED, REMOVED
  budgetAmount    Decimal  @db.Decimal(10, 2)  // Daily budget
  biddingStrategy String

  // Targeting settings
  targetCpa       Decimal? @db.Decimal(10, 2)
  targetRoas      Decimal? @db.Decimal(5, 2)

  // Metrics at snapshot time
  impressions     Int      @default(0)
  clicks          Int      @default(0)
  cost            Decimal  @default(0) @db.Decimal(10, 2)
  conversions     Int      @default(0)
  conversionValue Decimal  @default(0) @db.Decimal(10, 2)

  // Counts
  activeAdGroups  Int      @default(0)
  activeAds       Int      @default(0)
  activeKeywords  Int      @default(0)

  createdAt       DateTime @default(now())

  @@unique([accountId, campaignId, snapshotDate])
  @@index([accountId])
  @@index([campaignId])
  @@index([snapshotDate])
}

// ============================================================================
// KADABRA: ACTION LOG (for audit trail)
// ============================================================================

enum ActionSource {
  USER
  AUTOMATION
  AI
  SYSTEM
}

model ActionLog {
  id              String       @id @default(cuid())
  accountId       String

  // What was changed
  entityType      EntityScope
  entityId        String
  entityName      String
  actionType      String       // CREATE, UPDATE, PAUSE, ENABLE, DELETE, etc.

  // Change details
  oldValue        String?      @db.Text  // JSON of old state
  newValue        String?      @db.Text  // JSON of new state
  changeDescription String     @db.Text  // Human-readable description

  // Who/what made the change
  source          ActionSource
  userId          String?      // If USER
  automationRuleId String?     // If AUTOMATION
  aiInsightId     String?      // If AI

  // Outcome
  success         Boolean      @default(true)
  errorMessage    String?      @db.Text

  createdAt       DateTime     @default(now())

  @@index([accountId])
  @@index([entityType, entityId])
  @@index([source])
  @@index([createdAt])
}

// ============================================================================
// KADABRA: AI CHAT SESSIONS
// ============================================================================

model AIChatSession {
  id              String   @id @default(cuid())
  userId          String

  // Context
  accountId       String?  // If chat is about specific account
  campaignId      String?  // If focused on specific campaign

  // Conversation history (JSON array)
  messages        String   @db.Text  // JSON: [{role, content, timestamp, toolCalls?}]

  // Session metadata
  title           String?  // Auto-generated or user-set title
  lastActivityAt  DateTime @default(now())

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([accountId])
  @@index([lastActivityAt])
}

// ============================================================================
// KADABRA: IN-APP ALERTS (generated by monitoring rules)
// ============================================================================

enum AlertSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum AlertCategory {
  PERFORMANCE      // Spend, CPA, CTR thresholds
  BUDGET           // Budget pacing, depletion
  STATUS           // Campaign paused, enabled, etc.
  QUALITY          // Quality score, ad relevance
  RECOMMENDATION   // Google's recommendations
  AUTOMATION       // Rule triggered, action queued
}

model KadabraAlert {
  id              String         @id @default(cuid())
  userId          String         // Owner of the alert

  // Alert details
  severity        AlertSeverity
  category        AlertCategory
  title           String
  message         String         @db.Text
  details         String?        @db.Text  // JSON: additional context

  // Entity context
  accountId       String
  campaignId      String?
  adGroupId       String?
  entityType      String?        // "campaign" | "ad_group" | "ad" | "keyword"
  entityId        String?
  entityName      String?

  // Source
  sourceType      String         @default("system")  // "system" | "automation" | "ai"
  automationRuleId String?       // If generated by automation rule
  insightId       String?        // If generated from AI insight

  // Suggested action
  suggestedAction String?        @db.Text  // JSON: {actionType, parameters, estimatedImpact}
  actionQueueItemId String?      // Link to action queue if action was created

  // Status
  isRead          Boolean        @default(false)
  isDismissed     Boolean        @default(false)
  dismissedAt     DateTime?
  expiresAt       DateTime?      // Optional: auto-dismiss after date

  createdAt       DateTime       @default(now())

  @@index([userId])
  @@index([accountId])
  @@index([isRead])
  @@index([severity])
  @@index([category])
  @@index([createdAt])
}

// ============================================================================
// KADABRA: CAMPAIGN PLANNER AI
// ============================================================================

enum CampaignPlanStatus {
  DRAFT
  PROCESSING
  COMPLETED
  ARCHIVED
  FAILED
}

model CampaignPlan {
  id                  String             @id @default(cuid())
  userId              String
  teamId              String?
  name                String
  status              CampaignPlanStatus @default(DRAFT)

  // Input data
  productUrl          String?
  productDescription  String?            @db.Text
  targetAudience      String?            @db.Text  // User's description of target audience
  monthlyBudget       Decimal?           @db.Decimal(10, 2)  // Optional budget constraint
  goals               String?            @db.Text  // User's campaign goals (leads, sales, traffic, etc.)
  documents           Json?              // Array of Vercel Blob URLs for uploaded files

  // v2 Enhancement fields
  competitorUrl       String?            // Competitor landing page to analyze
  industry            String?            // Selected industry for benchmarks (e.g., "saas", "ecommerce", "legal")

  // AI-generated plan (stored as structured JSON)
  plan                Json?              // Full structured plan object

  // Processing metadata
  processingStartedAt DateTime?
  processingError     String?            @db.Text

  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// KADABRA: ACTION QUEUE (copy-paste ready fixes)
// ============================================================================

enum ActionStatus {
  PENDING          // Ready to execute
  IN_PROGRESS      // User started manual execution
  COMPLETED        // User confirmed completion
  CANCELLED        // User cancelled
  EXPIRED          // Action no longer relevant
}

enum ActionPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model ActionQueueItem {
  id              String         @id @default(cuid())
  userId          String         // Owner of the action

  // Action details
  title           String
  description     String         @db.Text
  actionType      String         // "pause_campaign" | "adjust_budget" | "add_negative" | etc.
  priority        ActionPriority @default(MEDIUM)

  // Entity context
  accountId       String
  campaignId      String?
  adGroupId       String?
  entityType      String?        // "campaign" | "ad_group" | "ad" | "keyword"
  entityId        String?
  entityName      String?

  // Instructions (copy-paste ready)
  instructions    String         @db.Text  // Step-by-step instructions
  copyableValues  String?        @db.Text  // JSON: values user can copy-paste
  googleAdsDeepLink String?      // Direct link to Google Ads entity

  // Source
  sourceType      String         @default("manual")  // "manual" | "automation" | "ai" | "alert"
  alertId         String?        // Link to alert that created this
  automationRuleId String?
  insightId       String?

  // Impact estimation
  estimatedImpact String?        @db.Text  // JSON: {metric, currentValue, expectedValue}

  // Status tracking
  status          ActionStatus   @default(PENDING)
  statusUpdatedAt DateTime       @default(now())
  completedAt     DateTime?
  completedNotes  String?        @db.Text  // User notes on completion

  // Expiration
  expiresAt       DateTime?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([userId])
  @@index([accountId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

// ============================================================================
// AI VIDEO CLIPPER
// ============================================================================

enum VideoJobStatus {
  PENDING           // Job created, waiting to start
  DOWNLOADING       // Downloading video from YouTube
  ANALYZING         // AI analyzing video for key moments
  CLIPPING          // Creating clips from identified moments
  CAPTIONING        // Adding auto-captions to clips
  COMPLETED         // All clips ready
  FAILED            // Job failed
}

enum ClipStatus {
  PENDING           // Clip identified but not processed
  PROCESSING        // Being generated
  CAPTIONING        // Adding captions
  COMPLETED         // Ready for download
  FAILED            // Failed to generate
}

model VideoClipJob {
  id                  String         @id @default(cuid())
  userId              String
  name                String?        // User-provided name for the job

  // Source video
  sourceType          String         // "youtube" | "upload"
  sourceUrl           String?        // YouTube URL
  uploadedVideoUrl    String?        // Vercel Blob URL for uploaded video
  videoDuration       Int?           // Duration in seconds
  videoTitle          String?        // Extracted video title
  videoThumbnail      String?        // Thumbnail URL

  // Processing status
  status              VideoJobStatus @default(PENDING)
  progress            Int            @default(0)  // 0-100 percentage
  processingError     String?        @db.Text

  // AI Analysis results (JSON)
  analysisResults     String?        @db.Text  // JSON: transcript, detected moments, scores

  // Settings
  targetFormat        String         @default("vertical")  // "vertical" | "square" | "horizontal"
  targetDuration      Int            @default(60)  // Target clip duration in seconds (15-90)
  maxClips            Int            @default(5)   // Max clips to generate
  addCaptions         Boolean        @default(true)
  captionStyle        String         @default("modern")  // "minimal" | "modern" | "bold" | "branded"

  // Industry/context for AI
  industry            String?        // "saas" | "ecommerce" | "coaching" | etc.
  productContext      String?        @db.Text  // What is the product/service
  targetAudience      String?        @db.Text  // Who is the target audience

  // Timestamps
  startedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  // Relations
  clips               VideoClip[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model VideoClip {
  id                  String      @id @default(cuid())
  jobId               String

  // Clip timing
  startTime           Int         // Start time in seconds
  endTime             Int         // End time in seconds
  duration            Int         // Duration in seconds

  // AI Analysis
  momentType          String      // "hook" | "testimonial" | "benefit" | "cta" | "social_proof" | "urgency"
  marketingScore      Int         // 1-100 score for marketing effectiveness
  conversionPotential Int         // 1-100 score for conversion potential
  hookStrength        Int         // 1-100 how strong the opening hook is
  emotionalImpact     Int         // 1-100 emotional resonance

  // AI explanation
  whySelected         String      @db.Text  // AI explanation of why this moment was selected
  suggestedCaption    String?     // AI suggested caption/headline for the clip
  keyMoments          String?     @db.Text  // JSON: timestamps of key frames within clip
  transcript          String?     @db.Text  // Transcript for this clip segment

  // Score breakdowns (JSON) - detailed factors explaining each score
  marketingScoreBreakdown   Json?  // {factors: [{name, score, weight, reason}], improvementTips: []}
  hookStrengthBreakdown     Json?  // Hook-specific breakdown
  conversionBreakdown       Json?  // Conversion-specific breakdown

  // Platform recommendations
  platformRecommendations   Json?  // {google_ads: {fit: 85, reasons: [], adjustments: []}, ...}

  // Generated ad copy
  googleAdsHeadlines        Json?  // ["Headline 1", "Headline 2", ...] (30 char max each)
  googleAdsDescriptions     Json?  // ["Description 1", ...] (90 char max each)
  youtubeHook               String? @db.Text  // Skip-proof opening line for Shorts
  reelsCaption              String? @db.Text  // Native caption with hashtags

  // Improvement suggestions
  improvementSuggestions    Json?  // ["Add specific numbers", "Include CTA", ...]

  // Extracted quotes
  keyQuotes                 Json?  // ["Best quote from clip", ...]

  // Processing status
  status              ClipStatus  @default(PENDING)
  processingProgress  Int         @default(0)
  processingError     String?     @db.Text
  replicatePredictionId String?   // Replicate prediction ID for cancellation

  // Output files (Vercel Blob URLs)
  clipUrl             String?     // Final processed clip
  clipWithCaptionsUrl String?     // Clip with burned-in captions
  thumbnailUrl        String?     // Auto-generated thumbnail

  // Metadata
  fileSize            Int?        // Size in bytes
  resolution          String?     // e.g., "1080x1920"

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  // Relations
  job                 VideoClipJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([marketingScore])
  @@index([status])
}
